<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Buddy Task Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Space Grotesk', sans-serif;
    }
    html, body {
      height: 100%;
    }
    .task-card {
      transition: all 0.2s ease;
    }
    .task-card:hover {
      transform: translateY(-2px);
    }
    .priority-badge {
      animation: pulse-soft 2s infinite;
    }
    @keyframes pulse-soft {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .alert-box {
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app-wrapper" class="h-full w-full overflow-auto" style="background: #fef7ed;">
   <div class="max-w-2xl mx-auto p-6"><!-- Header -->
    <header class="text-center mb-8">
     <h1 id="app-title" class="text-3xl font-bold mb-2" style="color: #1e293b;">ğŸ“š Study Buddy</h1>
     <p class="text-sm" style="color: #64748b;">Smart task prioritization for busy students</p>
    </header><!-- Add Task Form -->
    <div class="rounded-2xl p-6 mb-6 shadow-sm" style="background: #ffffff;">
     <div class="flex items-center justify-between mb-4">
      <h2 class="font-semibold flex items-center gap-2" style="color: #1e293b;"><span>âœ¨</span> Add New Task</h2><button type="button" id="toggle-quick-add" class="text-xs px-3 py-1 rounded-lg transition" style="background: #f0f9ff; color: #0369a1;"> Quick Add â†’ </button>
     </div><!-- Quick Add Form (hidden by default) -->
     <form id="quick-add-form" class="space-y-3 hidden mb-4 pb-4 border-b" style="border-color: #e2e8f0;">
      <div><label for="quick-title" class="block text-sm font-medium mb-1" style="color: #1e293b;">What do you need to do?</label> <input type="text" id="quick-title" placeholder="e.g., Finish math homework" required class="w-full px-4 py-3 rounded-xl border-2 focus:outline-none focus:ring-2 transition" style="border-color: #e2e8f0; background: #ffffff; color: #1e293b;">
      </div>
      <div><label for="quick-deadline" class="block text-sm font-medium mb-1" style="color: #1e293b;">ğŸ“… Deadline</label> <input type="datetime-local" id="quick-deadline" required class="w-full px-4 py-3 rounded-xl border-2 focus:outline-none focus:ring-2 transition" style="border-color: #e2e8f0; background: #ffffff; color: #1e293b;">
      </div><button type="submit" class="w-full py-2 px-4 rounded-xl font-semibold text-white transition hover:opacity-90" style="background: #f97316;"> Quick Add (30 mins, Medium) </button>
     </form>
     <form id="task-form" class="space-y-4">
      <div><label for="task-title" class="block text-sm font-medium mb-1" style="color: #1e293b;">What do you need to do?</label> <input type="text" id="task-title" placeholder="e.g., Finish math homework" required class="w-full px-4 py-3 rounded-xl border-2 focus:outline-none focus:ring-2 transition" style="border-color: #e2e8f0; background: #ffffff; color: #1e293b;">
      </div>
      <div class="grid grid-cols-2 gap-4">
       <div><label for="task-deadline" class="block text-sm font-medium mb-1" style="color: #1e293b;">ğŸ“… Deadline</label> <input type="datetime-local" id="task-deadline" required class="w-full px-4 py-3 rounded-xl border-2 focus:outline-none focus:ring-2 transition" style="border-color: #e2e8f0; background: #ffffff; color: #1e293b;">
       </div>
       <div><label for="task-duration" class="block text-sm font-medium mb-1" style="color: #1e293b;">â±ï¸ Duration (mins)</label> <input type="number" id="task-duration" min="5" max="480" placeholder="30" required class="w-full px-4 py-3 rounded-xl border-2 focus:outline-none focus:ring-2 transition" style="border-color: #e2e8f0; background: #ffffff; color: #1e293b;">
       </div>
      </div>
      <div><label class="block text-sm font-medium mb-2" style="color: #1e293b;">ğŸ¯ How important is this?</label>
       <div class="flex gap-3"><label class="flex-1 cursor-pointer"> <input type="radio" name="importance" value="low" class="sr-only peer">
         <div class="text-center py-3 px-4 rounded-xl border-2 peer-checked:border-green-500 peer-checked:bg-green-50 transition" style="border-color: #e2e8f0;"><span class="text-lg">ğŸ˜Œ</span>
          <p class="text-xs mt-1 font-medium">Low</p>
         </div></label> <label class="flex-1 cursor-pointer"> <input type="radio" name="importance" value="medium" class="sr-only peer" checked>
         <div class="text-center py-3 px-4 rounded-xl border-2 peer-checked:border-yellow-500 peer-checked:bg-yellow-50 transition" style="border-color: #e2e8f0;"><span class="text-lg">ğŸ¤”</span>
          <p class="text-xs mt-1 font-medium">Medium</p>
         </div></label> <label class="flex-1 cursor-pointer"> <input type="radio" name="importance" value="high" class="sr-only peer">
         <div class="text-center py-3 px-4 rounded-xl border-2 peer-checked:border-red-500 peer-checked:bg-red-50 transition" style="border-color: #e2e8f0;"><span class="text-lg">ğŸ”¥</span>
          <p class="text-xs mt-1 font-medium">High</p>
         </div></label>
       </div>
      </div><button type="submit" id="submit-btn" class="w-full py-3 px-6 rounded-xl font-semibold text-white transition hover:opacity-90 disabled:opacity-50" style="background: #f97316;"> Add Task </button>
     </form>
    </div><!-- Warnings and Suggestions -->
    <div id="alerts-container" class="space-y-4 mb-6"></div><!-- Suggested Task -->
    <div id="suggestion-card" class="hidden rounded-2xl p-5 mb-6 border-2 border-dashed fade-in" style="border-color: #f97316; background: #fff7ed;">
     <div class="flex items-start gap-3"><span class="text-2xl">ğŸ¯</span>
      <div class="flex-1">
       <p class="text-xs font-medium uppercase tracking-wide" style="color: #f97316;">Start with this one!</p>
       <p id="suggestion-title" class="font-semibold" style="color: #1e293b;"></p>
       <p id="suggestion-time" class="text-xs mt-1" style="color: #92400e;"></p>
       <p id="suggestion-timing" class="text-xs mt-2 px-3 py-1 rounded-lg inline-block" style="background: #fef3c7; color: #92400e;"></p>
       <div class="flex gap-2 mt-3"><button id="start-focus-btn" class="text-xs px-3 py-2 rounded-lg font-medium transition" style="background: #f97316; color: #ffffff;"> ğŸ¯ Start Focus Session </button> <button id="edit-suggestion-btn" class="text-xs px-3 py-2 rounded-lg font-medium transition edit-btn-suggestion" style="background: #e2e8f0; color: #1e293b;"> âœï¸ Edit </button>
       </div>
      </div>
     </div><!-- Focus Mode UI (hidden by default) -->
     <div id="focus-mode" class="hidden mt-4 pt-4 border-t" style="border-color: #fed7aa;">
      <div class="text-center mb-4">
       <p class="text-sm" style="color: #92400e;">Focus Session Active</p>
       <div id="focus-timer" class="text-4xl font-bold mt-2" style="color: #f97316; font-family: 'Space Grotesk', monospace;">
        00:00
       </div>
      </div>
      <div class="space-y-2"><button id="pause-focus-btn" class="w-full py-2 px-3 rounded-lg text-sm font-medium transition" style="background: #fef3c7; color: #92400e;"> â¸ï¸ Pause Session </button> <button id="complete-focus-btn" class="w-full py-2 px-3 rounded-lg text-sm font-medium text-white transition" style="background: #22c55e;"> âœ… Finish &amp; Mark Complete </button> <button id="cancel-focus-btn" class="w-full py-2 px-3 rounded-lg text-sm font-medium transition" style="background: #fee2e2; color: #dc2626;"> âŒ Cancel Session </button>
      </div>
     </div>
    </div><!-- Daily Progress Summary -->
    <div id="progress-summary" class="hidden rounded-2xl p-4 mb-6 shadow-sm" style="background: #f0fdf4; border: 1px solid #86efac;">
     <div class="flex items-center justify-between">
      <div>
       <p class="text-xs font-medium uppercase" style="color: #16a34a;">Today's Progress</p>
       <p id="progress-text" class="text-sm font-semibold mt-1" style="color: #1e293b;"></p>
      </div>
      <div class="text-2xl" id="progress-emoji">
       ğŸ“Š
      </div>
     </div>
    </div><!-- Task Lists -->
    <div id="tasks-container" class="space-y-6"><!-- Do Now Section -->
     <section id="do-now-section" class="hidden">
      <h3 class="font-semibold mb-3 flex items-center gap-2" style="color: #dc2626;"><span class="w-3 h-3 rounded-full bg-red-500 priority-badge"></span> Do Now ğŸš¨</h3>
      <div id="do-now-tasks" class="space-y-3"></div>
     </section><!-- Do Next Section -->
     <section id="do-next-section" class="hidden">
      <h3 class="font-semibold mb-3 flex items-center gap-2" style="color: #f59e0b;"><span class="w-3 h-3 rounded-full bg-yellow-500"></span> Do Next ğŸ“‹</h3>
      <div id="do-next-tasks" class="space-y-3"></div>
     </section><!-- Can Wait Section -->
     <section id="can-wait-section" class="hidden">
      <h3 class="font-semibold mb-3 flex items-center gap-2" style="color: #22c55e;"><span class="w-3 h-3 rounded-full bg-green-500"></span> Can Wait ğŸŒ¿</h3>
      <div id="can-wait-tasks" class="space-y-3"></div>
     </section>
    </div><!-- Empty State -->
    <div id="empty-state" class="text-center py-12">
     <div class="text-6xl mb-4">
      ğŸ“
     </div>
     <h3 id="empty-title" class="font-semibold text-lg mb-2" style="color: #1e293b;">No tasks yet!</h3>
     <p class="text-sm" style="color: #64748b;">Add your first task above to get started</p>
    </div><!-- Completed Section -->
    <section id="completed-section" class="hidden mt-6"><button id="toggle-completed" class="w-full text-left font-medium py-2 flex items-center gap-2" style="color: #64748b;"> <span id="completed-arrow">â–¶</span> <span>Completed Tasks</span> <span id="completed-count" class="text-xs px-2 py-1 rounded-full" style="background: #e2e8f0;"></span> </button>
     <div id="completed-tasks" class="space-y-3 mt-3 hidden"></div>
    </section>
   </div>
  </div><!-- Edit Task Modal -->
  <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4" style="backdrop-filter: blur(2px);">
   <div class="rounded-2xl p-6 shadow-lg max-w-md w-full fade-in" style="background: #ffffff;">
    <h3 class="text-lg font-semibold mb-4" style="color: #1e293b;">Edit Task</h3>
    <form id="edit-form" class="space-y-4">
     <div><label for="edit-title" class="block text-sm font-medium mb-1" style="color: #1e293b;">Title</label> <input type="text" id="edit-title" required class="w-full px-4 py-2 rounded-lg border-2 focus:outline-none focus:ring-2 transition" style="border-color: #e2e8f0; background: #ffffff; color: #1e293b;">
     </div>
     <div><label for="edit-deadline" class="block text-sm font-medium mb-1" style="color: #1e293b;">ğŸ“… Deadline</label> <input type="datetime-local" id="edit-deadline" required class="w-full px-4 py-2 rounded-lg border-2 focus:outline-none focus:ring-2 transition" style="border-color: #e2e8f0; background: #ffffff; color: #1e293b;">
     </div>
     <div><label for="edit-duration" class="block text-sm font-medium mb-1" style="color: #1e293b;">â±ï¸ Duration (mins)</label> <input type="number" id="edit-duration" min="5" max="480" required class="w-full px-4 py-2 rounded-lg border-2 focus:outline-none focus:ring-2 transition" style="border-color: #e2e8f0; background: #ffffff; color: #1e293b;">
     </div>
     <div><label class="block text-sm font-medium mb-2" style="color: #1e293b;">ğŸ¯ Importance</label>
      <div class="flex gap-2"><label class="flex-1 cursor-pointer"> <input type="radio" name="edit-importance" value="low" class="sr-only peer">
        <div class="text-center py-2 px-3 rounded-lg border-2 peer-checked:border-green-500 peer-checked:bg-green-50 transition" style="border-color: #e2e8f0;"><span class="text-sm">ğŸ˜Œ</span>
        </div></label> <label class="flex-1 cursor-pointer"> <input type="radio" name="edit-importance" value="medium" class="sr-only peer">
        <div class="text-center py-2 px-3 rounded-lg border-2 peer-checked:border-yellow-500 peer-checked:bg-yellow-50 transition" style="border-color: #e2e8f0;"><span class="text-sm">ğŸ¤”</span>
        </div></label> <label class="flex-1 cursor-pointer"> <input type="radio" name="edit-importance" value="high" class="sr-only peer">
        <div class="text-center py-2 px-3 rounded-lg border-2 peer-checked:border-red-500 peer-checked:bg-red-50 transition" style="border-color: #e2e8f0;"><span class="text-sm">ğŸ”¥</span>
        </div></label>
      </div>
     </div>
     <div class="flex gap-3 pt-4"><button type="submit" class="flex-1 py-2 px-4 rounded-lg font-semibold text-white transition" style="background: #f97316;"> Save Changes </button> <button type="button" id="cancel-edit-btn" class="flex-1 py-2 px-4 rounded-lg font-semibold transition" style="background: #e2e8f0; color: #1e293b;"> Cancel </button>
     </div>
    </form>
   </div>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      app_title: 'Study Buddy',
      empty_message: 'No tasks yet!',
      background_color: '#fef7ed',
      surface_color: '#ffffff',
      text_color: '#1e293b',
      primary_action: '#f97316',
      secondary_text: '#64748b'
    };

    let config = { ...defaultConfig };
    let tasks = [];
    let showCompleted = false;
    let focusSessionActive = false;
    let focusTaskId = null;
    let focusTimeRemaining = 0;
    let focusIntervalId = null;
    let editingTaskId = null;

    // LocalStorage helper functions with fail-safe persistence
    const STORAGE_KEY = 'studybuddy_tasks';
    const BACKUP_KEY = 'studybuddy_tasks_backup';
    let lastSavedState = null;

    function loadTasks() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          lastSavedState = JSON.stringify(parsed);
          return parsed;
        }
      } catch (e) {
        console.error('Primary load failed, attempting backup:', e);
        try {
          const backup = localStorage.getItem(BACKUP_KEY);
          if (backup) {
            const parsed = JSON.parse(backup);
            lastSavedState = JSON.stringify(parsed);
            return parsed;
          }
        } catch (backupError) {
          console.error('Backup load also failed:', backupError);
        }
      }
      return [];
    }

    function saveTasks(tasksArray) {
      try {
        const serialized = JSON.stringify(tasksArray);
        
        if (lastSavedState === serialized) {
          return true;
        }
        
        localStorage.setItem(STORAGE_KEY, serialized);
        
        const verified = localStorage.getItem(STORAGE_KEY);
        if (verified !== serialized) {
          throw new Error('Verification failed: saved data does not match');
        }
        
        try {
          localStorage.setItem(BACKUP_KEY, serialized);
        } catch (backupError) {
          console.warn('Backup save failed, but primary save succeeded:', backupError);
        }
        
        lastSavedState = serialized;
        return true;
      } catch (e) {
        console.error('Failed to save tasks to localStorage:', e);
        console.warn('Emergency: Saving to memory fallback');
        return false;
      }
    }

    window.addEventListener('beforeunload', () => {
      if (tasks && tasks.length > 0) {
        saveTasks(tasks);
      }
    });

    function calculatePriorityScore(task) {
      const now = new Date();
      const deadline = new Date(task.deadline);
      const msUntilDue = deadline - now;
      const hoursUntilDue = msUntilDue / (1000 * 60 * 60);
      const durationHours = task.duration / 60;
      
      const importanceScore = { high: 5, medium: 3, low: 1 }[task.importance];
      
      let urgencyScore = 0;
      if (msUntilDue <= 0) {
        urgencyScore = 10;
      } else if (hoursUntilDue < durationHours) {
        urgencyScore = 9;
      } else if (hoursUntilDue < durationHours * 1.5) {
        urgencyScore = 8;
      } else if (hoursUntilDue < 24) {
        urgencyScore = 6;
      } else if (hoursUntilDue < 48) {
        urgencyScore = 4;
      } else if (hoursUntilDue < 72) {
        urgencyScore = 3;
      } else {
        urgencyScore = 1;
      }
      
      const totalScore = (urgencyScore * 2.5) + importanceScore;
      
      return {
        totalScore,
        urgencyScore,
        importanceScore,
        hoursUntilDue,
        durationHours,
        isImpossible: hoursUntilDue > 0 && hoursUntilDue < durationHours,
        isOverdue: msUntilDue <= 0
      };
    }

    function categorizeTask(task) {
      const score = calculatePriorityScore(task);
      const { totalScore, hoursUntilDue, durationHours } = score;
      
      if (totalScore >= 15 || score.isImpossible || hoursUntilDue <= durationHours * 2) {
        return 'do-now';
      } else if (totalScore >= 10 || (hoursUntilDue > 0 && hoursUntilDue <= 48)) {
        return 'do-next';
      } else {
        return 'can-wait';
      }
    }

    function analyzeWorkload(activeTasks) {
      const warnings = [];
      const now = new Date();

      if (activeTasks.length === 0) return warnings;

      const next24Hours = activeTasks.filter(t => {
        const score = calculatePriorityScore(t);
        return score.hoursUntilDue > 0 && score.hoursUntilDue <= 24 && t.importance === 'high';
      });

      if (next24Hours.length >= 3) {
        const totalMinutes = next24Hours.reduce((sum, t) => sum + t.duration, 0);
        const minutesLeft = Math.max(0, next24Hours[0] ? Math.round((new Date(next24Hours[0].deadline) - now) / (1000 * 60)) : 0);
        warnings.push({
          type: 'collision',
          severity: 'high',
          message: `âš ï¸ <strong>Major Collision!</strong> ${next24Hours.length} high-priority tasks due in 24 hours, but you need ${totalMinutes} minutes and only have ~${minutesLeft}. Consider asking for an extension or deprioritizing one.`,
          count: next24Hours.length,
          totalMinutes
        });
      } else if (next24Hours.length === 2) {
        const totalMinutes = next24Hours.reduce((sum, t) => sum + t.duration, 0);
        warnings.push({
          type: 'collision',
          severity: 'medium',
          message: `ğŸ¤¯ <strong>Busy 24 Hours!</strong> Two high-priority tasks colliding (${totalMinutes} mins total). Plan carefully and work efficiently.`,
          count: 2,
          totalMinutes
        });
      }

      const doNowTasks = activeTasks.filter(t => categorizeTask(t) === 'do-now' && !calculatePriorityScore(t).isOverdue);
      
      if (doNowTasks.length > 0) {
        const totalMinutesNeeded = doNowTasks.reduce((sum, t) => sum + t.duration, 0);
        
        if (totalMinutesNeeded > 180) {
          warnings.push({
            type: 'burnout',
            severity: 'high',
            message: `ğŸ’ª <strong>Burnout Alert!</strong> You have ${totalMinutesNeeded} minutes of urgent work (${Math.round(totalMinutesNeeded / 60)} hours). That's a lot for today! Break it into chunks and take breaks every 45 mins.`,
            totalMinutes: totalMinutesNeeded
          });
        }
        
        const earliestDeadline = Math.min(
          ...doNowTasks.map(t => {
            const score = calculatePriorityScore(t);
            return Math.max(1, score.hoursUntilDue);
          })
        );
        
        const minutesAvailable = Math.round(earliestDeadline * 60);

        if (totalMinutesNeeded > minutesAvailable && totalMinutesNeeded <= 180) {
          const deficit = totalMinutesNeeded - minutesAvailable;
          warnings.push({
            type: 'unrealistic',
            severity: 'high',
            message: `ğŸ˜° <strong>Unrealistic Workload!</strong> You need ${totalMinutesNeeded} mins but only have ~${minutesAvailable} mins available. You're short by ${deficit} mins. Focus on highest-priority tasks first.`,
            deficit
          });
        } else if (totalMinutesNeeded > minutesAvailable * 0.7 && totalMinutesNeeded <= 180) {
          warnings.push({
            type: 'tight',
            severity: 'medium',
            message: `â° <strong>Tight Timeline!</strong> You need ${totalMinutesNeeded} mins and have ~${minutesAvailable} mins. Work efficientlyâ€”no time for breaks!`,
            needed: totalMinutesNeeded,
            available: minutesAvailable
          });
        }
      }

      const impossibleTasks = activeTasks.filter(t => {
        const score = calculatePriorityScore(t);
        return score.isImpossible && t.importance === 'high';
      });

      if (impossibleTasks.length > 0 && !warnings.some(w => w.type === 'unrealistic')) {
        const task = impossibleTasks[0];
        warnings.push({
          type: 'impossible',
          severity: 'high',
          message: `ğŸš¨ <strong>Impossible Deadline!</strong> "${task.title}" needs ${task.duration} mins but deadline is in < ${Math.round((new Date(task.deadline) - now) / (1000 * 60))} mins. Start NOW or ask for help!`,
          taskTitle: task.title
        });
      }

      return warnings;
    }

    function renderAlerts(warnings) {
      const container = document.getElementById('alerts-container');
      container.innerHTML = '';

      warnings.forEach(warning => {
        const div = document.createElement('div');
        div.className = 'alert-box rounded-xl p-4 shadow-sm';
        
        let bgColor, borderColor;
        if (warning.severity === 'high') {
          bgColor = '#fee2e2';
          borderColor = '#fca5a5';
        } else {
          bgColor = '#fef3c7';
          borderColor = '#fcd34d';
        }
        
        div.style.background = bgColor;
        div.style.borderLeft = `4px solid ${borderColor}`;
        div.innerHTML = `<p style="color: #1e293b; line-height: 1.5;">${warning.message}</p>`;
        
        container.appendChild(div);
      });
    }

    function formatDeadline(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = date - now;
      const minutes = Math.floor(diff / (1000 * 60));
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(hours / 24);
      
      if (diff < 0) return 'âš ï¸ Overdue!';
      if (minutes < 60) return `${minutes} mins left`;
      if (hours < 24) return `${hours}h ${minutes % 60}m left`;
      if (days === 1) return 'Tomorrow';
      if (days < 7) return `${days} days left`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function createTaskElement(task) {
      const score = calculatePriorityScore(task);
      const category = categorizeTask(task);
      const deadlineText = formatDeadline(task.deadline);
      const isOverdue = score.isOverdue;
      
      const div = document.createElement('div');
      div.className = 'task-card rounded-xl p-4 shadow-sm fade-in cursor-pointer hover:shadow-md transition';
      div.style.background = config.surface_color || defaultConfig.surface_color;
      div.dataset.taskId = task.id;
      
      const importanceEmoji = { high: 'ğŸ”¥', medium: 'ğŸ¤”', low: 'ğŸ˜Œ' }[task.importance];
      const impossibleFlag = score.isImpossible ? 'âš ï¸ ' : '';
      
      div.innerHTML = `
        <div class="flex items-start gap-3">
          <button class="complete-btn mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center hover:bg-green-50 transition flex-shrink-0 ${task.completed ? 'bg-green-500 border-green-500' : ''}" 
            style="border-color: ${task.completed ? '#22c55e' : '#e2e8f0'};" data-id="${task.id}">
            ${task.completed ? '<span class="text-white text-sm">âœ“</span>' : ''}
          </button>
          <div class="flex-1 min-w-0">
            <p class="font-medium ${task.completed ? 'line-through opacity-50' : ''}" style="color: ${config.text_color || defaultConfig.text_color};">${task.title}</p>
            <div class="flex flex-wrap items-center gap-2 mt-2 text-xs" style="color: ${config.secondary_text || defaultConfig.secondary_text};">
              <span class="${isOverdue ? 'text-red-500 font-semibold' : ''}">${impossibleFlag}${deadlineText}</span>
              <span>â€¢</span>
              <span>${task.duration} mins</span>
              <span>â€¢</span>
              <span>${importanceEmoji}</span>
            </div>
          </div>
          <div class="flex gap-1 flex-shrink-0">
            <button class="edit-btn p-2 rounded-lg hover:bg-blue-50 transition text-blue-400 hover:text-blue-600" data-id="${task.id}" title="Edit task">
              âœï¸
            </button>
            <button class="delete-btn p-2 rounded-lg hover:bg-red-50 transition text-red-400 hover:text-red-600" data-id="${task.id}" title="Delete task">
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
      `;
      
      return div;
    }

    function attachTaskEventListeners() {
      document.querySelectorAll('.complete-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          toggleComplete(btn.dataset.id);
        };
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          deleteTask(btn.dataset.id);
        };
      });
      
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          if (!focusSessionActive) {
            openEditModal(btn.dataset.id);
          }
        };
      });
    }

    function renderTasks() {
      const activeTasks = tasks.filter(t => !t.completed);
      const completedTasks = tasks.filter(t => t.completed);
      
      const warnings = analyzeWorkload(activeTasks);
      renderAlerts(warnings);
      
      const categorized = activeTasks.map(task => ({
        task,
        category: categorizeTask(task),
        score: calculatePriorityScore(task)
      })).sort((a, b) => {
        const categoryOrder = { 'do-now': 0, 'do-next': 1, 'can-wait': 2 };
        if (categoryOrder[a.category] !== categoryOrder[b.category]) {
          return categoryOrder[a.category] - categoryOrder[b.category];
        }
        if (b.score.totalScore !== a.score.totalScore) {
          return b.score.totalScore - a.score.totalScore;
        }
        return a.score.hoursUntilDue - b.score.hoursUntilDue;
      });
      
      const doNow = categorized.filter(c => c.category === 'do-now').map(c => c.task);
      const doNext = categorized.filter(c => c.category === 'do-next').map(c => c.task);
      const canWait = categorized.filter(c => c.category === 'can-wait').map(c => c.task);
      
      const doNowSection = document.getElementById('do-now-section');
      const doNextSection = document.getElementById('do-next-section');
      const canWaitSection = document.getElementById('can-wait-section');
      const completedSection = document.getElementById('completed-section');
      const emptyState = document.getElementById('empty-state');
      const suggestionCard = document.getElementById('suggestion-card');
      const progressSummary = document.getElementById('progress-summary');
      
      const doNowContainer = document.getElementById('do-now-tasks');
      doNowContainer.innerHTML = '';
      doNow.forEach(task => doNowContainer.appendChild(createTaskElement(task)));
      doNowSection.classList.toggle('hidden', doNow.length === 0);
      
      const doNextContainer = document.getElementById('do-next-tasks');
      doNextContainer.innerHTML = '';
      doNext.forEach(task => doNextContainer.appendChild(createTaskElement(task)));
      doNextSection.classList.toggle('hidden', doNext.length === 0);
      
      const canWaitContainer = document.getElementById('can-wait-tasks');
      canWaitContainer.innerHTML = '';
      canWait.forEach(task => canWaitContainer.appendChild(createTaskElement(task)));
      canWaitSection.classList.toggle('hidden', canWait.length === 0);
      
      const completedContainer = document.getElementById('completed-tasks');
      completedContainer.innerHTML = '';
      completedTasks.forEach(task => completedContainer.appendChild(createTaskElement(task)));
      completedSection.classList.toggle('hidden', completedTasks.length === 0);
      document.getElementById('completed-count').textContent = completedTasks.length;
      
      emptyState.classList.toggle('hidden', activeTasks.length > 0);
      
      const totalTodayTasks = tasks.filter(t => {
        const deadline = new Date(t.deadline);
        const today = new Date();
        return deadline.toDateString() === today.toDateString();
      }).length;
      
      if (totalTodayTasks > 0) {
        const completedTodayTasks = tasks.filter(t => {
          const deadline = new Date(t.deadline);
          const today = new Date();
          return t.completed && deadline.toDateString() === today.toDateString();
        }).length;
        
        const percentage = Math.round((completedTodayTasks / totalTodayTasks) * 100);
        const progressEmoji = percentage === 100 ? 'ğŸ‰' : percentage >= 75 ? 'ğŸ”¥' : percentage >= 50 ? 'ğŸ’ª' : 'ğŸ“Š';
        
        document.getElementById('progress-text').textContent = `${completedTodayTasks} of ${totalTodayTasks} tasks completed (${percentage}%)`;
        document.getElementById('progress-emoji').textContent = progressEmoji;
        progressSummary.classList.remove('hidden');
      } else {
        progressSummary.classList.add('hidden');
      }
      
      if (categorized.length > 0) {
        suggestionCard.classList.remove('hidden');
        const topTask = categorized[0];
        document.getElementById('suggestion-title').textContent = topTask.task.title;
        
        const score = topTask.score;
        let timeText = '';
        if (score.hoursUntilDue < 1) {
          timeText = `${Math.round(score.hoursUntilDue * 60)} minutes`;
        } else if (score.hoursUntilDue < 24) {
          timeText = `${Math.round(score.hoursUntilDue * 10) / 10} hours`;
        } else {
          timeText = `${Math.round(score.hoursUntilDue / 24 * 10) / 10} days`;
        }
        
        const urgentFlag = score.isImpossible ? 'ğŸ”´ ' : (score.isOverdue ? 'âš ï¸ ' : '');
        document.getElementById('suggestion-time').textContent = `${urgentFlag}â° ${timeText} left â€¢ ${topTask.task.duration} mins needed`;
        
        const now = new Date();
        const buffer = 5;
        const startTime = new Date(now.getTime() + buffer * 60000);
        const endTime = new Date(startTime.getTime() + topTask.task.duration * 60000);
        
        const startStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const endStr = endTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        document.getElementById('suggestion-timing').textContent = `ğŸ“… ${startStr} â†’ ${endStr}`;
        
        document.getElementById('start-focus-btn').onclick = () => startFocusSession(topTask.task.id);
        document.getElementById('edit-suggestion-btn').onclick = () => {
          if (!focusSessionActive) {
            openEditModal(topTask.task.id);
          }
        };
      } else {
        suggestionCard.classList.add('hidden');
      }
      
      attachTaskEventListeners();
      
      document.getElementById('pause-focus-btn').onclick = pauseFocusSession;
      document.getElementById('complete-focus-btn').onclick = () => {
        if (focusTaskId) {
          const task = tasks.find(t => t.id === focusTaskId);
          if (task) task.completed = true;
        }
        endFocusSession();
        saveTasks(tasks);
        renderTasks();
      };
      document.getElementById('cancel-focus-btn').onclick = () => {
        endFocusSession();
        renderTasks();
      };
      
      saveTasks(tasks);
    }

    function toggleComplete(id) {
      const taskIndex = tasks.findIndex(t => t.id === id);
      if (taskIndex !== -1) {
        tasks[taskIndex].completed = !tasks[taskIndex].completed;
        saveTasks(tasks);
        renderTasks();
      }
    }

    function deleteTask(id) {
      const btn = document.querySelector(`.delete-btn[data-id="${id}"]`);
      if (btn.dataset.confirming === 'true') {
        tasks = tasks.filter(t => t.id !== id);
        saveTasks(tasks);
        renderTasks();
      } else {
        btn.dataset.confirming = 'true';
        btn.textContent = 'âœ“ Sure?';
        btn.classList.add('text-red-600', 'font-semibold');
        setTimeout(() => {
          if (btn.dataset.confirming === 'true') {
            btn.dataset.confirming = 'false';
            btn.textContent = 'ğŸ—‘ï¸';
            btn.classList.remove('text-red-600', 'font-semibold');
          }
        }, 3000);
      }
    }

    document.getElementById('toggle-quick-add').addEventListener('click', () => {
      const form = document.getElementById('quick-add-form');
      form.classList.toggle('hidden');
    });

    document.getElementById('quick-add-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const title = document.getElementById('quick-title').value.trim();
      const deadline = document.getElementById('quick-deadline').value;
      
      const newTask = {
        id: Date.now().toString(),
        title,
        deadline,
        duration: 30,
        importance: 'medium',
        completed: false,
        createdAt: new Date().toISOString()
      };
      
      tasks.push(newTask);
      saveTasks(tasks);
      
      e.target.reset();
      document.getElementById('quick-add-form').classList.add('hidden');
      renderTasks();
    });

    function startFocusSession(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      
      focusSessionActive = true;
      focusTaskId = taskId;
      focusTimeRemaining = task.duration * 60;
      
      document.getElementById('focus-mode').classList.remove('hidden');
      document.getElementById('start-focus-btn').style.display = 'none';
      document.getElementById('edit-suggestion-btn').style.display = 'none';
      
      updateFocusTimer();
      focusIntervalId = setInterval(updateFocusTimer, 1000);
    }

    function updateFocusTimer() {
      const minutes = Math.floor(focusTimeRemaining / 60);
      const seconds = focusTimeRemaining % 60;
      const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      
      document.getElementById('focus-timer').textContent = display;
      
      if (focusTimeRemaining <= 0) {
        clearInterval(focusIntervalId);
        autoCompleteFocusSession();
      }
      
      focusTimeRemaining--;
    }

    function autoCompleteFocusSession() {
      const task = tasks.find(t => t.id === focusTaskId);
      if (task) {
        task.completed = true;
        saveTasks(tasks);
      }
      
      endFocusSession();
      renderTasks();
      
      const timer = document.getElementById('focus-timer');
      timer.textContent = 'ğŸ‰';
      timer.style.fontSize = '2em';
      
      setTimeout(() => {
        timer.style.fontSize = '2.25em';
        timer.textContent = '00:00';
      }, 1500);
    }

    function pauseFocusSession() {
      clearInterval(focusIntervalId);
      document.getElementById('pause-focus-btn').textContent = 'â–¶ï¸ Resume Session';
      document.getElementById('pause-focus-btn').onclick = resumeFocusSession;
    }

    function resumeFocusSession() {
      focusIntervalId = setInterval(updateFocusTimer, 1000);
      document.getElementById('pause-focus-btn').textContent = 'â¸ï¸ Pause Session';
      document.getElementById('pause-focus-btn').onclick = null;
    }

    function endFocusSession() {
      focusSessionActive = false;
      focusTaskId = null;
      focusTimeRemaining = 0;
      clearInterval(focusIntervalId);
      
      document.getElementById('focus-mode').classList.add('hidden');
      document.getElementById('start-focus-btn').style.display = 'inline-block';
      document.getElementById('edit-suggestion-btn').style.display = 'inline-block';
      document.getElementById('pause-focus-btn').textContent = 'â¸ï¸ Pause Session';
      document.getElementById('pause-focus-btn').onclick = null;
    }

    function openEditModal(taskId) {
      if (focusSessionActive) return;
      
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      
      editingTaskId = taskId;
      document.getElementById('edit-title').value = task.title;
      document.getElementById('edit-deadline').value = task.deadline;
      document.getElementById('edit-duration').value = task.duration;
      document.querySelector(`input[name="edit-importance"][value="${task.importance}"]`).checked = true;
      
      document.getElementById('edit-modal').classList.remove('hidden');
    }

    function closeEditModal() {
      editingTaskId = null;
      document.getElementById('edit-modal').classList.add('hidden');
    }

    document.getElementById('edit-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const task = tasks.find(t => t.id === editingTaskId);
      if (!task) return;
      
      task.title = document.getElementById('edit-title').value.trim();
      task.deadline = document.getElementById('edit-deadline').value;
      task.duration = parseInt(document.getElementById('edit-duration').value);
      task.importance = document.querySelector('input[name="edit-importance"]:checked').value;
      
      saveTasks(tasks);
      closeEditModal();
      renderTasks();
    });

    document.getElementById('cancel-edit-btn').addEventListener('click', closeEditModal);

    document.getElementById('edit-modal').addEventListener('click', (e) => {
      if (e.target.id === 'edit-modal') {
        closeEditModal();
      }
    });

    document.getElementById('task-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const title = document.getElementById('task-title').value.trim();
      const deadline = document.getElementById('task-deadline').value;
      const duration = parseInt(document.getElementById('task-duration').value);
      const importance = document.querySelector('input[name="importance"]:checked').value;
      
      const newTask = {
        id: Date.now().toString(),
        title,
        deadline,
        duration,
        importance,
        completed: false,
        createdAt: new Date().toISOString()
      };
      
      tasks.push(newTask);
      saveTasks(tasks);
      
      e.target.reset();
      document.querySelector('input[name="importance"][value="medium"]').checked = true;
      renderTasks();
    });

    document.getElementById('toggle-completed').addEventListener('click', () => {
      showCompleted = !showCompleted;
      document.getElementById('completed-tasks').classList.toggle('hidden', !showCompleted);
      document.getElementById('completed-arrow').textContent = showCompleted ? 'â–¼' : 'â–¶';
    });

    function onConfigChange(cfg) {
      config = { ...defaultConfig, ...cfg };
      
      document.getElementById('app-title').textContent = 'ğŸ“š ' + (config.app_title || defaultConfig.app_title);
      document.getElementById('empty-title').textContent = config.empty_message || defaultConfig.empty_message;
      
      document.getElementById('app-wrapper').style.background = config.background_color || defaultConfig.background_color;
      
      renderTasks();
    }

    const elementConfig = {
      defaultConfig,
      onConfigChange,
      mapToCapabilities: (cfg) => ({
        recolorables: [
          {
            get: () => cfg.background_color || defaultConfig.background_color,
            set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
          },
          {
            get: () => cfg.surface_color || defaultConfig.surface_color,
            set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
          },
          {
            get: () => cfg.text_color || defaultConfig.text_color,
            set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
          },
          {
            get: () => cfg.primary_action || defaultConfig.primary_action,
            set: (v) => { cfg.primary_action = v; window.elementSdk.setConfig({ primary_action: v }); }
          },
          {
            get: () => cfg.secondary_text || defaultConfig.secondary_text,
            set: (v) => { cfg.secondary_text = v; window.elementSdk.setConfig({ secondary_text: v }); }
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      }),
      mapToEditPanelValues: (cfg) => new Map([
        ['app_title', cfg.app_title || defaultConfig.app_title],
        ['empty_message', cfg.empty_message || defaultConfig.empty_message]
      ])
    };

    function init() {
      tasks = loadTasks();
      
      if (window.elementSdk) {
        window.elementSdk.init(elementConfig);
      }
      
      renderTasks();
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cb3ca868041a559',t:'MTc3MDY0NDU1OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
